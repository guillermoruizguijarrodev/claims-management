<div class="max-w-6xl mx-auto p-6">
    
    <p-confirmDialog></p-confirmDialog>
    <p-toast></p-toast>

    @if (!claim()) {
        <div class="flex justify-center items-center h-64">
            <i class="pi pi-spin pi-spinner text-4xl"></i>
        </div>
    } @else {
        
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <p-button icon="pi pi-arrow-left" [rounded]="true" [text]="true" routerLink="/" />
                    <h1 class="text-3xl font-bold">Claim Details</h1>
                    
                    <p-tag [value]="claim()!.status" [severity]="getSeverityColor(claim()!.status)" />

                    <p-button 
                        icon="pi pi-pencil" 
                        [rounded]="true" 
                        [text]="true" 
                        severity="secondary" 
                        (onClick)="openStatusDialog()"
                        pTooltip="Change Status"
                    />
                </div>
                <p class="ml-12">{{ claim()!.title }}</p>
                <p class="text-sm ml-12 mt-1">{{ claim()!.description }}</p>
            </div>

            <div class="bg-blue-50 border border-blue-200 px-6 py-4 rounded-xl shadow-sm text-right min-w-[200px]">
                <p class="text-sm font-semibold text-blue-600 uppercase tracking-wider">Total Estimated</p>
                <p class="text-3xl font-bold text-gray-900 animate-pulse-once">
                    {{ totalAmount() | currency:'EUR':'symbol':'1.2-2' }}
                </p>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            
            <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-700">Damages Log</h3>
                <p-button 
                    label="Add New Damage" 
                    icon="pi pi-plus" 
                    (onClick)="showAddDialog()" 
                    size="small"
                    [disabled]="!isEditable()"
                    [pTooltip]="!isEditable() ? 'Only pending claims can be modified' : ''"
                    tooltipPosition="left"
                />
            </div>

            <p-table [value]="claim()?.damages || []" [tableStyle]="{ 'min-width': '50rem' }">
                <ng-template pTemplate="header">
                    <tr>
                        <th style="width: 30%">Part / Description</th>
                        <th style="width: 15%">Severity</th>
                        <th style="width: 20%">Price</th>
                        <th style="width: 20%">Image Reference</th>
                        <th style="width: 15%" class="text-right">Actions</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-damage>
                    <tr>
                        <td>
                            <span class="font-medium">{{ damage.part }}</span>
                        </td>

                        <td>
                            <p-tag [value]="damage.severity" [severity]="getSeverityColor(damage.severity)" />
                        </td>

                        <td>
                            {{ damage.price | currency:'EUR':'symbol':'1.2-2' }}
                        </td>

                        <td>
                            @if (damage.imageUrl) {
                                <a [href]="damage.imageUrl" target="_blank" class="text-blue-600 hover:underline text-sm">
                                    <i class="pi pi-image mr-1"></i>View Image
                                </a>
                            } @else {
                                <span class="text-gray-400 italic text-sm">No image</span>
                            }
                        </td>

                        <td class="text-right">
                            <div class="flex justify-end gap-2">
                                <p-button 
                                icon="pi pi-pencil" 
                                [rounded]="true" 
                                [text]="true" 
                                severity="secondary" 
                                (onClick)="showEditDialog(damage)" 
                                [disabled]="!isEditable()"
                            />
                            
                            <p-button 
                                icon="pi pi-trash" 
                                [rounded]="true" 
                                [text]="true" 
                                severity="danger" 
                                (onClick)="deleteDamage(damage)" 
                                [disabled]="!isEditable()"
                            />
                            </div>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="5" class="text-center p-8 text-gray-500">
                            No damages recorded yet.
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    }
</div>

<p-dialog 
    [(visible)]="displayDialog" 
    [header]="isEditing ? 'Edit Damage' : 'Add New Damage'" 
    [modal]="true" 
    styleClass="w-[30vw] min-w-[300px]" [closable]="false"
>
    <div class="mt-2">
        <app-damage-fields [group]="damageForm" />
    </div>

    <ng-template pTemplate="footer">
        <p-button label="Cancel" icon="pi pi-times" [text]="true" (onClick)="displayDialog = false" />
        <p-button label="Save" icon="pi pi-check" (onClick)="saveDamage()" [disabled]="damageForm.invalid" />
    </ng-template>
</p-dialog>

<p-dialog 
    [(visible)]="displayStatusDialog" 
    header="Update Claim Status" 
    [modal]="true" 
    [style]="{ width: '300px' }" 
    [draggable]="false" 
    [resizable]="false">
    
    <div class="flex flex-col gap-4 pt-2">
        <label class="font-semibold text-gray-600">Select New Status</label>
        
        <p-select 
            [options]="statusOptions" 
            [formControl]="statusControl" 
            optionLabel="label" 
            optionValue="value" 
            [style]="{'width':'100%'}" 
            appendTo="body" 
        />
    </div>

    <ng-template pTemplate="footer">
        <p-button label="Cancel" [text]="true" severity="secondary" (onClick)="displayStatusDialog = false" />
        <p-button label="Update" icon="pi pi-check" (onClick)="saveStatus()" [disabled]="statusControl.invalid" />
    </ng-template>
</p-dialog>